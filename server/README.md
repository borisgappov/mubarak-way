# MubarakWay Server

Серверное приложение MubarakWay на базе NestJS.

## Описание

Бэкенд-сервер для приложения MubarakWay, который работает как прокси-сервер с дополнительными локальными функциями:
- **Proxy** - проксирование запросов к внешнему API (https://bot.e-replika.ru) с автоматическим логированием просмотров
- **Statistics** (Статистика) - статистика активности пользователя (время изучения, активность по дням, история просмотров)
- **Goal Notes** (Заметки к целям) - управление заметками пользователя к целям
- **User Metadata** (Метаданные пользователя) - хранение метаданных (заметки, история просмотров, счетчики)

## Архитектура

- **NestJS** - основной фреймворк
- **TypeORM** - ORM для работы с базой данных (SQLite)
- **JWT** - аутентификация пользователей
- **Axios** - проксирование запросов к внешнему API
- **Passport** - стратегия аутентификации JWT
- **class-validator** - валидация данных

## Установка

```bash
npm install
```

## Настройка

Создайте файл `.env` в корне проекта:

```env
# Server Configuration
PORT=3000
NODE_ENV=development

# Database Configuration
DATABASE_PATH=mubarakway.db

# JWT Configuration
JWT_SECRET=your-secret-key-change-in-production
JWT_EXPIRES_IN=7d

# External API Configuration
API_BASE_URL=https://bot.e-replika.ru
API_TOKEN=test_token_123

# Frontend Configuration
FRONTEND_URL=*
```

## Запуск приложения

```bash
# Режим разработки (с автоперезагрузкой)
npm run dev

# Продакшн режим (сборка и запуск)
npm run build
npm run prod

# Обычный запуск
npm run start
```

## API Endpoints

### Проксирование запросов

Большинство запросов к API проксируются к внешнему серверу `https://bot.e-replika.ru`. При проксировании автоматически логируются просмотры целей, дуа и имен Аллаха для последующего анализа статистики.

**Все запросы к `/api/v1/*` (кроме `/api/v1/statistics` и `/api/v1/goal-notes`) проксируются к внешнему API.**

Примеры проксируемых эндпоинтов:
- `GET /api/v1/goals` - получить список целей
- `GET /api/v1/goals/:goalId` - получить цель
- `POST /api/v1/goals` - создать цель
- `GET /api/v1/duas` - получить список дуа
- `GET /api/v1/allah-names` - получить список имен Аллаха
- И другие эндпоинты внешнего API

**Примечание:** При проксировании запросов автоматически извлекается `userId` из JWT токена в заголовке `Authorization`, и просмотры логируются в базу данных для статистики.

### Локальные эндпоинты

#### Statistics (Статистика)
- `GET /api/v1/statistics` - получить полную статистику пользователя
  - Query параметры:
    - `startDate` (опционально) - начальная дата (формат: ISO string)
    - `endDate` (опционально) - конечная дата (формат: ISO string)
  - Возвращает:
    - `totalStudyHours` - общее время изучения в часах
    - `goalsVisited` - количество уникальных просмотренных целей
    - `duasViewed` - количество уникальных просмотренных дуа
    - `allahNamesViewed` - количество уникальных просмотренных имен Аллаха
    - `activityByDay` - активность по дням (массив объектов `{date, count}`)

#### Goal Notes (Заметки к целям)
- `POST /api/v1/goal-notes` - создать заметку к цели
  - Body: `{ goalId: string, content: string }`
- `GET /api/v1/goal-notes` - получить все заметки пользователя
  - Query параметры:
    - `goalId` (опционально) - фильтр по ID цели
- `GET /api/v1/goal-notes/:id` - получить заметку по ID
- `PUT /api/v1/goal-notes/:id` - обновить заметку
  - Body: `{ content: string }`
- `DELETE /api/v1/goal-notes/:id` - удалить заметку

**Все локальные эндпоинты требуют JWT аутентификации** (заголовок `Authorization: Bearer <token>`).

## Тестирование

```bash
# unit тесты
npm run test

# e2e тесты
npm run test:e2e

# покрытие тестами
npm run test:cov
```

## Структура проекта

```
src/
├── auth/                    # Модуль аутентификации (JWT)
│   ├── auth.module.ts       # Модуль аутентификации
│   ├── auth.service.ts      # Сервис аутентификации
│   ├── jwt.strategy.ts      # Passport JWT стратегия
│   └── jwt-auth.guard.ts    # JWT guard для защиты роутов
├── database/                # Конфигурация базы данных
│   └── database.module.ts   # TypeORM конфигурация (SQLite)
├── entities/                # Сущности TypeORM
│   ├── user-metadata.entity.ts    # Метаданные пользователя
│   ├── view-history.entity.ts     # История просмотров
│   └── goal-note.entity.ts        # Заметки к целям
├── decorators/              # Кастомные декораторы
│   └── user.decorator.ts    # Декоратор для получения текущего пользователя
├── proxy/                   # Модуль проксирования запросов
│   ├── proxy.module.ts      # Модуль прокси
│   ├── proxy.controller.ts  # Контроллер прокси (обрабатывает все запросы *)
│   └── proxy.service.ts     # Сервис проксирования с логированием просмотров
├── user-metadata/           # Модуль метаданных пользователя
│   ├── user-metadata.module.ts    # Модуль метаданных
│   ├── user-metadata.service.ts   # Сервис работы с метаданными
│   └── statistics.controller.ts   # Контроллер статистики
├── goal-notes/              # Модуль заметок к целям
│   ├── goal-note.module.ts  # Модуль заметок
│   ├── goal-note.service.ts # Сервис заметок
│   └── goal-note.controller.ts    # Контроллер заметок
├── app.module.ts            # Корневой модуль приложения
├── app.service.ts           # Корневой сервис
└── main.ts                  # Точка входа приложения
```

## Особенности реализации

### Проксирование запросов

Сервер работает как прокси между клиентом и внешним API (`https://bot.e-replika.ru`). При проксировании:

1. **Автоматическое логирование просмотров**: При запросах к целям, дуа и именам Аллаха автоматически извлекается `userId` из JWT токена и логируется событие просмотра в базу данных.

2. **Проброс заголовков**: Все заголовки от клиента пробрасываются к внешнему API (кроме системных заголовков).

3. **Авторизация**: Если клиент не передал токен, используется токен из переменной окружения `API_TOKEN`.

### Статистика

Статистика рассчитывается на основе истории просмотров:
- **Время изучения**: Рассчитывается как сумма интервалов между последовательными просмотрами (если интервал < 2 часов)
- **Активность по дням**: Подсчет количества просмотров по дням
- **Уникальные просмотры**: Подсчет уникальных целей, дуа и имен Аллаха

### База данных

Используется SQLite с тремя основными таблицами:
- `user_metadata` - метаданные пользователя (последний просмотр, счетчик просмотров, заметки)
- `view_history` - история всех просмотров
- `goal_notes` - заметки пользователя к целям

## Разработка

### Сборка проекта

```bash
npm run build
```

Скомпилированные файлы будут находиться в директории `dist/`.

### Линтинг и форматирование

```bash
# Проверка кода линтером
npm run lint

# Форматирование кода
npm run format
```

### Отладка

```bash
# Запуск с отладкой
npm run debug
```

## Поддержка

Приложение работает на порту 3000 по умолчанию (настраивается через переменную окружения `PORT`).

## Технологии

- **NestJS 10.x** - прогрессивный Node.js фреймворк
- **TypeORM 0.3.x** - ORM для TypeScript
- **SQLite3** - встроенная база данных
- **Passport JWT** - стратегия аутентификации
- **Axios** - HTTP клиент для проксирования
- **class-validator** - валидация DTO
- **TypeScript 5.x** - язык программирования
